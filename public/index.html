<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è¡ŒåŠ¨</title>
    <style>
        /* æç®€ iOS é£æ ¼ */
        body { background-color: #F2F2F7; font-family: -apple-system, sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; }
        .card { background: white; width: 100%; max-width: 400px; padding: 24px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; }
        h2 { margin-bottom: 24px; color: #1C1C1E; font-size: 22px; }
        .btn { width: 100%; padding: 16px; margin-bottom: 12px; border: none; border-radius: 14px; font-size: 17px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: #007AFF; color: white; }
        .btn-success { background: #34C759; color: white; }
        .btn-danger { background: #FF3B30; color: white; }
        .btn-outline { background: #E5E5EA; color: #1C1C1E; }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-size: 14px; color: #8E8E93; }
        input, select { width: 100%; padding: 12px; border: 1px solid #E5E5EA; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #F2F2F7; }
        .hidden { display: none; }
        .loading { color: #8E8E93; font-size: 14px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="loading" class="loading">æ­£åœ¨åŒæ­¥å¤§è„‘... ğŸ§ </div>

    <div id="scene-active" class="card hidden">
        <h2>æ­£åœ¨è¿›è¡Œä¸­... â³</h2>
        <p id="current-task-info" style="margin-bottom: 30px; font-size: 18px; color: #333; font-weight: 500;"></p>
        <button class="btn btn-success" onclick="finishTask()">âœ… å®Œæˆè®°å½•</button>
        <button class="btn btn-outline" onclick="closeApp()">ç¨åå†çœ‹</button>
    </div>

    <div id="scene-category" class="card hidden">
        <h2>ç°åœ¨è¦å¼€å§‹ä»€ä¹ˆï¼ŸğŸš€</h2>
        <div id="cat-buttons"></div> </div>

    <div id="scene-detail" class="card hidden">
        <h2>å…·ä½“å†…å®¹</h2>
        <div class="input-group">
            <label>äºŒçº§åˆ†ç±» (å¯ç›´æ¥è¾“å…¥)</label>
            <input type="text" id="input-sub" placeholder="ä¾‹å¦‚ï¼šå†™ä»£ç  / ä¼šè®®">
        </div>
        <div class="input-group">
            <label>å…·ä½“è¦åšä»€ä¹ˆï¼Ÿ</label>
            <input type="text" id="input-detail" placeholder="è¾“å…¥ä»»åŠ¡è¯¦æƒ…...">
        </div>
        <button class="btn btn-primary" onclick="submitStart()">ğŸš€ å¼€å§‹</button>
        <button class="btn btn-outline" onclick="reset()">è¿”å›</button>
    </div>

    <script>
        // å®šä¹‰ä¸€çº§åˆ†ç±»
        const MAIN_CATS = ["å­¦ä¹ ", "å·¥ä½œ", "å¨±ä¹", "è¿åŠ¨", "ç”Ÿæ´»"];
        let selectedMainCat = "";
        let currentRecordId = "";

        // åˆå§‹åŒ–
        window.onload = async () => {
            try {
                // æ¸²æŸ“ä¸€çº§åˆ†ç±»æŒ‰é’®
                const catContainer = document.getElementById('cat-buttons');
                MAIN_CATS.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.innerText = cat;
                    btn.onclick = () => selectMainCat(cat);
                    catContainer.appendChild(btn);
                });

                // æ£€æŸ¥çŠ¶æ€
                const res = await fetch('/api');
                const data = await res.json(); // é»˜è®¤è¯·æ±‚ get (action=check)
                
                document.getElementById('loading').classList.add('hidden');
                
                if (data.hasActive) {
                    currentRecordId = data.recordId;
                    document.getElementById('current-task-info').innerText = data.info;
                    document.getElementById('scene-active').classList.remove('hidden');
                } else {
                    document.getElementById('scene-category').classList.remove('hidden');
                }
            } catch (e) {
                alert("è¿æ¥é”™è¯¯: " + e);
            }
        };

        // é€»è¾‘å‡½æ•°
        function selectMainCat(cat) {
            selectedMainCat = cat;
            document.getElementById('scene-category').classList.add('hidden');
            document.getElementById('scene-detail').classList.remove('hidden');
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            setTimeout(() => document.getElementById('input-sub').focus(), 100);
        }

        async function submitStart() {
            const sub = document.getElementById('input-sub').value || "å…¶ä»–";
            const detail = document.getElementById('input-detail').value || "æœªå¡«å†™è¯¦æƒ…";
            
            toggleLoading(true);
            await fetch('/api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'start', mainCat: selectedMainCat, subCat: sub, detail: detail })
            });
            alert("å·²å¼€å§‹ï¼");
            location.reload();
        }

        async function finishTask() {
            toggleLoading(true);
            await fetch('/api', {
                method: 'POST', // æˆ– PUT
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'finish', recordId: currentRecordId })
            });
            alert("è¾›è‹¦äº†ï¼å·²å½’æ¡£åˆ°æ—¥å† ğŸ“…");
            location.reload();
        }

        function toggleLoading(show) {
            if(show) {
                document.querySelectorAll('.card').forEach(e => e.classList.add('hidden'));
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('loading').innerText = "å¤„ç†ä¸­...";
            }
        }

        function reset() { location.reload(); }
        function closeApp() { 
            // å°è¯•å…³é—­çª—å£ (éƒ¨åˆ†æµè§ˆå™¨é™åˆ¶)
            window.history.back(); 
        }
    </script>
</body>
</html>